<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Map Video AI</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Cinematic Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --glass-bg: rgba(15, 15, 15, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.15);
            --accent: #0dcaf0;
            /* Cyan */
            --text: #ffffff;
        }

        body {
            background: #000;
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            font-family: 'Montserrat', sans-serif;
        }

        /* Map Container */
        #map {
            width: 100vw;
            height: 100vh;
            z-index: 1;
            background: #121212;
            transition: filter 0.5s ease;
        }

        /* UI Overlays */
        .ui-layer {
            position: absolute;
            inset: 0;
            z-index: 1000;
            pointer-events: none;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Narration Box (Bottom Left) */
        .narration-box {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: var(--glass-border);
            border-left: 4px solid var(--accent);
            padding: 24px;
            border-radius: 0 12px 12px 0;
            width: 90%;
            max-width: 420px;
            pointer-events: auto;
            transform: translateX(-120%);
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .narration-box.active {
            transform: translateX(0);
        }

        .narration-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            color: var(--accent);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .narration-text {
            font-size: 1.1rem;
            line-height: 1.6;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Controls (Bottom Right) */
        .controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 12px;
            pointer-events: auto;
        }

        .btn-glass {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-glass:hover {
            background: white;
            color: black;
            transform: scale(1.1);
        }

        .btn-glass.active {
            background: var(--accent);
            color: black;
            border-color: var(--accent);
        }

        /* Marker Styles */
        .marker-pulse {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 0 0 rgba(13, 202, 240, 0.7);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(13, 202, 240, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 20px rgba(13, 202, 240, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(13, 202, 240, 0);
            }
        }

        /* Top Bar */
        .top-bar {
            pointer-events: auto;
            display: flex;
            justify-content: flex-end;
        }

        .editor-btn {
            background: var(--glass-bg);
            border: var(--glass-border);
            color: #fff;
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            letter-spacing: 1px;
            transition: 0.3s;
            cursor: pointer;
        }

        .editor-btn:hover {
            background: var(--accent);
            color: #000;
        }

        /* Font Variations */
        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        .font-playfair {
            font-family: 'Playfair Display', serif;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div class="ui-layer">
        <div class="top-bar">
            <button class="editor-btn" data-bs-toggle="modal" data-bs-target="#editorModal">
                <i class="bi bi-pen me-2"></i>EDITOR
            </button>
        </div>

        <div class="narration-box" id="narrationCard">
            <div class="narration-title">
                <div class="spinner-grow spinner-grow-sm text-info" id="ttsLoader" style="display:none"></div>
                <span id="cardTitle">INFO</span>
            </div>
            <div class="narration-text" id="cardText">
                Load a script to begin journey.
            </div>
        </div>

        <div class="controls">
            <button class="btn-glass" id="playBtn"><i class="bi bi-play-fill"></i></button>
            <button class="btn-glass" id="soundBtn"><i class="bi bi-volume-up-fill"></i></button>
            <button class="btn-glass" id="fullBtn"><i class="bi bi-arrows-fullscreen"></i></button>
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div class="modal fade" id="editorModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title font-monospace text-info">SCRIPT CONTROL</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-pills mb-3" id="pills-tab">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-json">JSON Input</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-gen">AI Prompt Generator</button></li>
                    </ul>
                    <div class="tab-content">
                        <!-- JSON Editor -->
                        <div class="tab-pane fade show active" id="tab-json">
                            <textarea id="jsonInput" class="form-control bg-black text-success font-monospace border-0" rows="15" placeholder="// Paste JSON here..."></textarea>
                        </div>
                        <!-- Prompt Generator -->
                        <div class="tab-pane fade" id="tab-gen">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="text-secondary small">STORY TOPIC</label>
                                    <input type="text" id="p_topic" class="form-control bg-secondary text-white border-0" placeholder="e.g. History of Rome">
                                </div>
                                <div class="col-md-4">
                                    <label class="text-secondary small">MAP THEME</label>
                                    <select id="p_theme" class="form-select bg-secondary text-white border-0">
                                        <option value="dark">Dark Matter (Cinematic)</option>
                                        <option value="satellite">Satellite (Realistic)</option>
                                        <option value="voyager">Voyager (Clean)</option>
                                        <option value="light">Light (Classic)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="text-secondary small">LANGUAGE</label>
                                    <input type="text" id="p_lang" class="form-control bg-secondary text-white border-0" value="English">
                                </div>
                                <div class="col-12 mt-4">
                                    <div class="bg-black p-3 rounded border border-secondary">
                                        <pre id="finalPrompt" class="text-info m-0" style="white-space: pre-wrap; font-size: 0.8rem;"></pre>
                                    </div>
                                    <button class="btn btn-outline-info w-100 mt-2" onclick="copyPrompt()"><i class="bi bi-clipboard"></i> COPY PROMPT</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button class="btn btn-link text-white text-decoration-none" onclick="loadSample()">Load Sample</button>
                    <button class="btn btn-info px-4 fw-bold" onclick="runScript()">LOAD & PLAY</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- GLOBAL STATE ---
        let map;
        let script = null;
        let currentStep = 0;
        let isPlaying = false;
        let ttsEnabled = true;
        let activeLayer = null; // Stores current marker/highlight
        const synth = window.speechSynthesis;

        // --- MAP THEMES ---
        // We use different providers based on JSON "style" key
        const THEMES = {
            'dark': 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            'light': 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            'voyager': 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',
            'satellite': 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            'street': 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
        };

        // --- INIT ---
        window.addEventListener('load', () => {
            // Default Map Init
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false,
                fadeAnimation: true
            }).setView([20, 0], 2);

            // Load default dark theme initially
            L.tileLayer(THEMES['dark']).addTo(map);

            // Listeners
            document.getElementById('playBtn').onclick = togglePlay;
            document.getElementById('soundBtn').onclick = toggleMute;
            document.getElementById('fullBtn').onclick = toggleFull;

            // Live Prompt Update
            ['p_topic', 'p_theme', 'p_lang'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePrompt);
            });
            updatePrompt();
        });

        // --- PROMPT GENERATOR ---
        function updatePrompt() {
            const topic = document.getElementById('p_topic').value || "[TOPIC]";
            const theme = document.getElementById('p_theme').value;
            const lang = document.getElementById('p_lang').value;

            const txt = `Act as an expert map visualization architect.
Generate a strictly valid JSON script for a map video.

TOPIC: ${topic}
TARGET_STYLE: ${theme}
LANGUAGE: ${lang}

RULES:
1. Root object must have: "title", "style" ("${theme}"), "map" (initialCenter), "timeline" (array).
2. "timeline" items must have: "type", "location" [lat, lng], "narration" { "title", "text" }.
3. Types allowed: "pan", "zoom", "marker", "highlight".
4. Coordinates MUST be real [latitude, longitude] numbers.
5. Narration text should be concise (1-2 sentences) for video subtitles.
6. NO Markdown, NO Comments. Just RAW JSON.`;

            document.getElementById('finalPrompt').innerText = txt;
        }

        function copyPrompt() {
            navigator.clipboard.writeText(document.getElementById('finalPrompt').innerText);
            alert("Prompt Copied! Paste into AI.");
        }

        // --- SCRIPT ENGINE ---
        function runScript() {
            try {
                const raw = document.getElementById('jsonInput').value;
                script = JSON.parse(raw);

                // 1. Set Theme
                setMapTheme(script.style || 'dark');

                // 2. Reset State
                currentStep = 0;
                isPlaying = false;
                map.setView(script.map.initialCenter, script.map.initialZoom, {
                    animate: false
                });

                // 3. Close Modal & Ready
                bootstrap.Modal.getInstance(document.getElementById('editorModal')).hide();
                showCard("READY", script.title || "Untitled Project");
                document.getElementById('narrationCard').classList.add('active');

                // 4. Reset Button
                updatePlayIcon(false);

            } catch (e) {
                alert("JSON Parse Error: " + e.message);
            }
        }

        function setMapTheme(styleKey) {
            // Remove old layers
            map.eachLayer((layer) => {
                if (layer instanceof L.TileLayer) map.removeLayer(layer);
            });

            // Add new layer
            const url = THEMES[styleKey] || THEMES['dark'];
            L.tileLayer(url, {
                maxZoom: 19
            }).addTo(map);

            // Apply Filters for visibility
            const mapEl = document.getElementById('map');
            if (styleKey === 'satellite') {
                mapEl.style.filter = "brightness(1.1) contrast(1.1)";
            } else if (styleKey === 'dark') {
                mapEl.style.filter = "brightness(0.9) contrast(1.2)";
            } else {
                mapEl.style.filter = "none";
            }
        }

        function togglePlay() {
            if (!script) return alert("Please load a script first.");

            if (isPlaying) {
                isPlaying = false;
                synth.cancel();
                updatePlayIcon(false);
            } else {
                isPlaying = true;
                updatePlayIcon(true);
                if (synth.paused) synth.resume();
                else playNextStep();
            }
        }

        function playNextStep() {
            if (!isPlaying) return;
            if (currentStep >= script.timeline.length) {
                isPlaying = false;
                updatePlayIcon(false);
                showCard("END", "Presentation Finished.");
                return;
            }

            const event = script.timeline[currentStep];
            executeEvent(event);
        }

        function executeEvent(event) {
            // Visuals
            if (event.type === 'pan' || event.type === 'zoom') {
                map.flyTo(event.location, event.zoom || map.getZoom(), {
                    duration: 2.5
                });
            } else if (event.type === 'marker') {
                showMarker(event.location);
            } else if (event.type === 'highlight') {
                showHighlight(event.location);
            }

            // Narration
            if (event.narration) {
                showCard(event.narration.title, event.narration.text);

                if (ttsEnabled) {
                    speak(event.narration.text, () => {
                        currentStep++;
                        setTimeout(playNextStep, 800); // Pause between steps
                    });
                } else {
                    // Fallback timer
                    setTimeout(() => {
                        currentStep++;
                        playNextStep();
                    }, 4000);
                }
            } else {
                setTimeout(() => {
                    currentStep++;
                    playNextStep();
                }, 2000);
            }
        }

        // --- HELPERS ---
        function showMarker(coords) {
            if (activeLayer) map.removeLayer(activeLayer);
            const icon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="marker-pulse"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            activeLayer = L.marker(coords, {
                icon: icon
            }).addTo(map);
        }

        function showHighlight(coords) {
            if (activeLayer) map.removeLayer(activeLayer);
            activeLayer = L.circle(coords, {
                color: 'var(--accent)',
                fillColor: 'var(--accent)',
                fillOpacity: 0.3,
                radius: 150000
            }).addTo(map);
        }

        function showCard(title, text) {
            document.getElementById('cardTitle').innerText = title || "INFO";
            document.getElementById('cardText').innerText = text;

            // Font Randomizer
            const fonts = ['font-cinzel', 'font-playfair', ''];
            const randomFont = fonts[Math.floor(Math.random() * fonts.length)];
            const textEl = document.getElementById('cardText');
            textEl.className = 'narration-text ' + randomFont;

            document.getElementById('narrationCard').classList.add('active');
        }

        function speak(text, callback) {
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 1.0;

            const loader = document.getElementById('ttsLoader');
            loader.style.display = 'inline-block';

            u.onend = () => {
                loader.style.display = 'none';
                if (callback) callback();
            };
            synth.speak(u);
        }

        function updatePlayIcon(playing) {
            const btn = document.getElementById('playBtn');
            btn.innerHTML = playing ? '<i class="bi bi-pause-fill"></i>' : '<i class="bi bi-play-fill"></i>';
        }

        function toggleMute() {
            ttsEnabled = !ttsEnabled;
            const btn = document.getElementById('soundBtn');
            btn.innerHTML = ttsEnabled ? '<i class="bi bi-volume-up-fill"></i>' : '<i class="bi bi-volume-mute-fill"></i>';
            if (!ttsEnabled) synth.cancel();
        }

        function toggleFull() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        function loadSample() {
            const sample = {
                "title": "Satellite View Demo",
                "style": "satellite",
                "map": {
                    "initialCenter": [28.6139, 77.2090],
                    "initialZoom": 4
                },
                "timeline": [{
                        "type": "pan",
                        "location": [28.6139, 77.2090],
                        "zoom": 10,
                        "narration": {
                            "title": "New Delhi",
                            "text": "Welcome to New Delhi, viewed from space via satellite imagery."
                        }
                    },
                    {
                        "type": "marker",
                        "location": [28.6129, 77.2295],
                        "narration": {
                            "title": "India Gate",
                            "text": "Here stands the India Gate, a war memorial located astride the Rajpath."
                        }
                    },
                    {
                        "type": "pan",
                        "location": [19.0760, 72.8777],
                        "zoom": 10,
                        "narration": {
                            "title": "Mumbai",
                            "text": "Flying southwest, we arrive at the island city of Mumbai."
                        }
                    }
                ]
            };
            document.getElementById('jsonInput').value = JSON.stringify(sample, null, 2);
        }
    </script>
</body>

</html>
